<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Биология: СОР и СОЧ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      max-width: 800px;
      margin: auto;
      padding: 2em;
      background-color: #f4f6f8;
    }
    h1 {
      color: #2E5C92;
      text-align: center;
    }
    .block {
      background: white;
      border-radius: 10px;
      padding: 1.5em;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 1em;
    }
    input, textarea {
      width: 100%;
      padding: 0.5em;
      margin-top: 0.3em;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      padding: 0.5em 1.2em;
      margin: 0.5em 0.5em 0 0;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .start { background: #2E5C92; color: white; }
    .next { background: #4CAF50; color: white; }
    .back { background: #ccc; }
    .timer {
      text-align: center;
      font-size: 1.3em;
      font-weight: bold;
      color: #d63333;
    }
    .score {
      text-align: center;
      font-size: 1.2em;
      margin-top: 1em;
    }
    .scale {
      margin-top: 1em;
      padding: 1em;
      background: #e9f5ff;
      border-radius: 8px;
    }
    .manual-score {
      background: #fff8dc;
      padding: 0.5em;
      margin-top: 1em;
      border-radius: 5px;
    }
  </style>
</head>
<body>

<h1>Приложение «Биология: СОР и СОЧ»</h1>

<div class="block" id="start-screen">
  <label>ФИО:</label>
  <input id="fio" type="text">
  <label>Класс:</label>
  <input id="klass" type="text">
  <p><b>Цели обучения:</b></p>
  <ul>
    <li>8.4.2.2 сравнить строение клеток эукариот и прокариот</li>
    <li>8.4.1.1 описывать различия между мономерами и полимерами</li>
    <li>8.4.1.2 описывать свойства и функции углеводов и липидов</li>
    <li>8.4.1.3 описывать свойства и функции белков</li>
  </ul>
  <p><b>Макс. баллы за СОР: 12 | СОЧ: 30</b></p>
  <button class="start" onclick="startTest('SOR')">Начать СОР</button>
  <button class="start" onclick="startTest('SOCH')">Начать СОЧ</button>
</div>

<div class="block" id="test-screen" style="display:none;">
  <div class="timer" id="timer"></div>
  <p><b>Тип:</b> <span id="q-type"></span></p>
  <p id="q-text"></p>
  <div id="q-options"></div>
  <textarea id="q-answer" rows="4" style="display:none;" placeholder="Ваш ответ..."></textarea>
  <div>
    <button class="back" onclick="prevQuestion()">Назад</button>
    <button class="next" onclick="confirmFinish()">Завершить</button>
  </div>
  <div class="score" id="question-score"></div>
</div>

<div class="block" id="result-screen" style="display:none;">
  <h3 id="result-title"></h3>
  <p><strong>ФИО:</strong> <span id="result-fio"></span></p>
  <p><strong>Класс:</strong> <span id="result-klass"></span></p>
  <p><strong>Итоговый балл:</strong> <span id="total-score"></span></p>
  <div class="manual-score">
    <label for="manual">Изменить вручную:</label>
    <input type="number" id="manual" min="0" max="30" onchange="manualUpdateScore()">
  </div>
  <div class="scale">
    <h4>Шкала оценивания:</h4>
    <ul>
      <li>10–12 баллов — «Отлично»</li>
      <li>7–9 баллов — «Хорошо»</li>
      <li>4–6 баллов — «Удовлетворительно»</li>
      <li>0–3 балла — «Неудовлетворительно»</li>
    </ul>
  </div>
</div>

<button onclick="showAdminPanel()" style="position:fixed;bottom:10px;right:10px;background:#444;color:white;padding:0.5em 1em;border-radius:5px;">Панель администратора</button>

<script>
const questions = [
  {
    type: "МВО",
    question: "Какой орган отвечает за фотосинтез?",
    options: ["Кора", "Лист", "Корень", "Цветок"],
    correct: "Лист",
    score: 1
  },
  {
    type: "КО",
    question: "Назовите орган, в котором происходит дыхание растений.",
    score: 2
  },
  {
    type: "РО",
    question: "Опишите процесс круговорота воды в природе с биологической точки зрения.",
    score: 3
  }
];

let current = 0;
let timerInterval;
let seconds = 0;
let totalScore = 0;
let currentMode = "";
let answers = [];
let testSubmitted = false;

function startTest(mode) {
  currentMode = mode;
  document.getElementById("start-screen").style.display = "none";
  document.getElementById("test-screen").style.display = "block";
  seconds = mode === "SOR" ? 20 * 60 : 45 * 60;
  updateTimer();
  timerInterval = setInterval(() => {
    seconds--;
    updateTimer();
    if (seconds <= 0) {
      clearInterval(timerInterval);
      finishTest();
    }
  }, 1000);
  renderQuestion();
}

function updateTimer() {
  const min = Math.floor(seconds / 60);
  const sec = ("0" + (seconds % 60)).slice(-2);
  document.getElementById("timer").innerText = `Осталось: ${min}:${sec}`;
}

function renderQuestion() {
  const q = questions[current];
  document.getElementById("q-type").innerText = q.type;
  document.getElementById("q-text").innerText = q.question;
  document.getElementById("q-options").innerHTML = "";
  document.getElementById("q-answer").style.display = "none";
  document.getElementById("question-score").innerText = `Балл: ${q.score}`;

  if (q.type === "МВО") {
    q.options.forEach(opt => {
      const btn = document.createElement("button");
      btn.textContent = opt;
      btn.className = "next";
      btn.onclick = () => {
        if (opt === q.correct) totalScore += q.score;
        answers.push(`${q.question}\nОтвет: ${opt}`);
        nextQuestion();
      };
      document.getElementById("q-options").appendChild(btn);
    });
  } else {
    document.getElementById("q-answer").style.display = "block";
  }
}

function nextQuestion() {
  const q = questions[current];
  if (q.type !== "МВО") {
    const written = document.getElementById("q-answer").value;
    answers.push(`${q.question}\nОтвет: ${written}`);
    totalScore += q.score;
    document.getElementById("q-answer").value = "";
  }
  if (current < questions.length - 1) {
    current++;
    renderQuestion();
  } else {
    finishTest();
  }
}

function confirmFinish() {
  if (confirm("Вы точно хотите завершить тест?")) {
    nextQuestion();
  }
}

function prevQuestion() {
  if (current > 0) {
    current--;
    renderQuestion();
  }
}

function manualUpdateScore() {
  const val = parseInt(document.getElementById("manual").value);
  totalScore = val;
  document.getElementById("total-score").innerText = totalScore;
}

function finishTest() {
  if (testSubmitted) return;
  testSubmitted = true;
  clearInterval(timerInterval);
  document.getElementById("test-screen").style.display = "none";
  document.getElementById("result-screen").style.display = "block";
  document.getElementById("result-fio").innerText = document.getElementById("fio").value;
  document.getElementById("result-klass").innerText = document.getElementById("klass").value;
  document.getElementById("total-score").innerText = totalScore;
  document.getElementById("manual").value = totalScore;
  document.getElementById("result-title").innerText = currentMode === "SOR" ? "СОР завершен" : "СОЧ завершен";
  saveResultLocally();
}

function saveResultLocally() {
  const result = {
    fio: document.getElementById("fio").value,
    klass: document.getElementById("klass").value,
    mode: currentMode,
    score: totalScore,
    answers: answers,
    timestamp: new Date().toISOString()
  };
  const existing = JSON.parse(localStorage.getItem("biology_results") || "[]");
  existing.push(result);
  localStorage.setItem("biology_results", JSON.stringify(existing));
}

function exportResultsToCSV() {
  const results = JSON.parse(localStorage.getItem("biology_results") || "[]");
  if (!results.length) return alert("Нет данных для экспорта");
  let csv = "ФИО,Класс,Тип,Балл,Дата\n";
  results.forEach(r => {
    csv += `${r.fio},${r.klass},${r.mode},${r.score},${new Date(r.timestamp).toLocaleString()}\n`;
  });
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.setAttribute("href", URL.createObjectURL(blob));
  link.setAttribute("download", "результаты_биология.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function exportResultsToPDF() {
  const results = JSON.parse(localStorage.getItem("biology_results") || "[]");
  if (!results.length) return alert("Нет данных для экспорта");
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(12);
  doc.text("Результаты тестов", 10, 10);
  let y = 20;
  results.forEach((r, i) => {
    doc.text(`${i+1}. ${r.fio}, Класс: ${r.klass}, Тип: ${r.mode}, Балл: ${r.score}, ${new Date(r.timestamp).toLocaleString()}`, 10, y);
    y += 8;
    if (y > 270) { doc.addPage(); y = 20; }
  });
  doc.save("результаты_биология.pdf");
}

function showAdminPanel() {
  const pass = prompt("Введите пароль администратора:");
  if (pass !== "admin123") return;
  const results = JSON.parse(localStorage.getItem("biology_results") || "[]");
  let html = `<h2>Результаты</h2>
    <table border="1" cellpadding="5"><tr><th>ФИО</th><th>Класс</th><th>Тип</th><th>Балл</th><th>Дата</th></tr>
    ${results.map(r => `<tr><td>${r.fio}</td><td>${r.klass}</td><td>${r.mode}</td><td>${r.score}</td><td>${new Date(r.timestamp).toLocaleString()}</td></tr>`).join('')}</table>
    <br>
    <button onclick="window.opener.exportResultsToCSV()">Скачать Excel (CSV)</button>
    <button onclick="window.opener.exportResultsToPDF()">Скачать PDF</button>`;
  const w = window.open();
  w.document.write(`<html><head><title>Админ-панель</title></head><body>${html}</body></html>`);
}
</script>

</body>
</html>
